<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="./assets/css/cosmo-bootstrap.min.css" rel="stylesheet">
    <link href="./assets/css/font-awesome.min.css" rel="stylesheet">

    <script src="./assets/js/jquery.min.js" type="text/javascript"></script>
    <script src="./assets/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="./assets/js/ace/ace.js" type="text/javascript"></script>
    <script src="./assets/js/jquery.scrollintoview.js" type="text/javascript"></script>
</head>

<style type="text/css">
.ace_editor {
    margin-top: 10px;
    width: 100%;
    height: 250px;

    font-size: 14px;
    line-height: 20px;
}

.btn {
    padding: 5px 12px;
}

.list-group-item i {
    display: none;
}

.list-group-item.active i,
.list-group-item:hover i {
    float:right;
    padding: 5px 0;
    font-size: 13px;
    display: block;
}

.waiting {
    display: none;
}

.edit-panel {
    margin-top: 10px;
    display: none;
}

.form-control {
    height: 33px;
    padding: 0 6px;
}

</style>


<body>
    <br>
    <br>

    <div class="container">
        <div class="row">
            <div class="col-xs-3">
                <div class="list-group" role="navlist">
                    <!--
                    <a href="#" class="list-group-item active">
                        <i class="fa fa-chevron-right"></i> 01. Hello World
                    </a>
                    <a href="#" class="list-group-item">
                        <i class="fa fa-chevron-right"></i> 02. if/else/elseif
                    </a>
                    <a href="#" class="list-group-item">
                        <i class="fa fa-chevron-right"></i> 03. for/else
                    </a>
                    <a href="#" class="list-group-item">
                        <i class="fa fa-chevron-right"></i> 04. break/continue
                    </a>
                    <a href="#" class="list-group-item">
                        <i class="fa fa-chevron-right"></i> 05. include
                    </a>
                    <a href="#" class="list-group-item">
                        <i class="fa fa-chevron-right"></i> 06. Layout
                    </a>
                    <a href="#" class="list-group-item">
                        <i class="fa fa-chevron-right"></i> 07. Extends Method
                    </a>
                    <a href="#" class="list-group-item">
                        <i class="fa fa-chevron-right"></i> 08. Extends Function
                    </a>
                    <a href="#" class="list-group-item">
                        <i class="fa fa-chevron-right"></i> 09. Tag
                    </a>
                    <a href="#" class="list-group-item">
                        <i class="fa fa-chevron-right"></i> 10. Macro
                    </a>
                    <a href="#" class="list-group-item">
                        <i class="fa fa-chevron-right"></i> 11. safecall
                    </a>
                    <a href="#" class="list-group-item">
                        <i class="fa fa-chevron-right"></i> 12. format
                    </a>
                    <a href="#" class="list-group-item">
                        <i class="fa fa-chevron-right"></i> 13. Security Manager
                    </a>
                    -->
                </div>
            </div>


            <div class="col-xs-9">
                <div class="pull-right" role="toolbar">
                    <span style="font-size:18px;" class="waiting">
                        <i class="fa fa-spinner fa-spin"></i> &nbsp; Waiting... &nbsp; &nbsp; &nbsp;
                    </span>

                    <button class="btn btn-primary" title="Execute the template">
                        <i class="fa fa-play"></i> Execute
                    </button>

                    &nbsp;&nbsp;
                    <div class="btn-group">
                        <button class="btn btn-default" title="Add new template">
                            <i class="fa fa-plus"></i>
                        </button>
                        <button class="btn btn-default" title="Rename current template">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button class="btn btn-default" title="Delete current template">
                            <i class="fa fa-remove"></i>
                        </button>
                        <button class="btn btn-default" title="Set current template as main entry">
                            <i class="fa fa-heart"></i>
                        </button>
                    </div>
                    &nbsp;&nbsp;

                    <button class="btn btn-success" title="Share the template">
                        <i class="fa fa-share"></i> Share
                    </button>
                </div>

                <div role="file-pannel">
                    <ul class="nav nav-tabs">
                        <li class="active">
                            <a href="#file1" data-toggle="tab">
                                <i class="fa fa-file-text"></i> &nbsp; Main.jetx
                            </a>
                        </li>
                    </ul>
                    <div class="edit-panel">
                        <form class="form-inline">
                            <input type="text" class="form-control" autofocus="autofocus" placeholder="Input file name">
                            <button class="btn">
                                <i class="fa fa-check"></i>
                            </button>
                            <button class="btn">
                                <i class="fa fa-remove"></i>
                            </button>
                        </form>
                    </div>
                    <div class="tab-content">
                        <div class="tab-pane active" id="file1">
                            <div class="ace-editor" ace-mode="jetx" ace-readOnly="false"></div>
                        </div>
                    </div>
                </div>

                <br/>

                <div role="model-panel">
                    <ul class="nav nav-tabs">
                        <li class="active">
                            <a data-toggle="tab">
                                <i class="fa fa-file-code-o"></i> &nbsp; Model.json
                            </a>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane active">
                            <div class="ace-editor" ace-mode="json" ace-readOnly="false" style="height:150px;"></div>
                        </div>
                    </div>
                </div>
                <div style="margin-top:5px;color:#888">
                    Note: you can use <a href="#">sample model classes <i class="fa fa-external-link"></i></a> and most JDK classes as argument types
                </div>

                <br/>

                <div role="result-panel">
                    <ul class="nav nav-tabs">
                        <li class="active">
                            <a>
                                <i class="fa fa-th"></i> &nbsp; Execution Result
                            </a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active">
                            <div class="ace-editor" ace-mode="html" ace-readOnly="true"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <br/>
        <br/>
        <br/>
        <br/>
        <br/>

    </div>

<script type="text/javascript">
$(function () {
    initializeFileList();
    initializeAceEditor();
    initializeButtons();
});

function initializeFileList() {
    var $navlist = $('[role=navlist]');

    var url = 'http://127.0.0.1:8080/files?callback=?';
    $.getJSON(url, function(data) {
        var template = '<a href="#" class="list-group-item" file-id="{{id}}"><i class="fa fa-chevron-right"></i> {{id}}. {{desc}}</a>';
        for (var i=0; i<data.length; i++) {
            var html = template;
            html = html.replace(new RegExp('{{id}}', 'g'), data[i].id);
            html = html.replace('{{desc}}', data[i].desc);
            $navlist.append(html);
        }
    });

    var uuid = 100;
    $navlist.on('click', 'a', function() {
        var fileId = $(this).attr('file-id');
        var url = 'http://127.0.0.1:8080/files/' + fileId + '?callback=?';
        $.getJSON(url, function(data) {
            var template1 = '<li><a href="#{{id}}" data-toggle="tab"><i class="fa fa-file-text"></i> &nbsp; {{name}}</a></li>';
            var template2 = '<div class="tab-pane" id="{{id}}"><div class="ace-editor" ace-mode="jetx" ace-readOnly="false">{{source}}</div></div>';
            var html;
            var $tabs = $('[role=file-pannel] .nav-tabs').empty();
            var $editors = $('[role=file-pannel] .tab-content').empty();
            for (var i=0; i<data.files.length; i++) {
                var id = "u" + (uuid++);

                html = template1;
                html = html.replace('{{id}}', id);
                html = html.replace('{{name}}', data.files[i]);
                $tabs.append(html);

                html = template2;
                html = html.replace('{{id}}', id);
                html = html.replace('{{source}}', data.sources[i]);
                $editors.append(html);
            }

            var editor;
            editor = ace.edit($('[role=model-panel] .ace-editor')[0]);
            editor.getSession().setValue(data.model);
            editor = ace.edit($('[role=result-panel] .ace-editor')[0]);
            editor.getSession().setValue('');

            $tabs.find('li:first').addClass('active');
            initializeAceEditor();
            $editors.find('.tab-pane:first').addClass('active').slideDown();
        });

        $navlist.find('a.active').removeClass('active');
        $(this).addClass('active');
    });
}

function initializeAceEditor() {
    $('.ace-editor').each(function() {
        var $dom = $(this);
        var editor = ace.edit(this);
        editor.setTheme('ace/theme/monokai');
        editor.setShowPrintMargin(false);
        editor.setReadOnly($dom.attr('ace-readOnly') == 'true');
        var session = editor.getSession();
        session.setMode('ace/mode/' + $dom.attr('ace-mode'));
        session.setTabSize(4);
        session.setUseWrapMode(true);
        session.setNewLineMode('unix');
    });
}

function initializeButtons() {
    $('[role=toolbar] .fa-edit').parent().on('click', function() {
        $('.edit-panel input').val($.trim($('[role=file-pannel] .nav-tabs li.active').text()));
        $('.edit-panel').show();
    });

    $('[role=toolbar] .fa-play').parent().on('click', function() {
        var files = [], sources = [];
        $('[role=file-pannel] .nav-tabs a').each(function() {
            files.push($.trim($(this).text()));
        });
        $('[role=file-pannel] .ace-editor').each(function() {
            var editor = ace.edit(this);
            sources.push(editor.getSession().getValue());
        });

        var editor = ace.edit($('[role=model-panel] .ace-editor')[0]);

        var parameters = {
            files: JSON.stringify(files),
            sources: JSON.stringify(sources),
            model: editor.getSession().getValue(),
            entryIndex: 0
        };

        $('.waiting').show();

        var editor = ace.edit($('[role=result-panel] .ace-editor')[0]);
        editor.getSession().setValue('Waiting for execute ...');

        var url = "http://127.0.0.1:8080/execute";
        $.post(url, parameters, function(data) {
            $('.waiting').hide();
            editor.getSession().setValue(data.result);
            $('[role=result-panel]').scrollintoview();
        }, 'jsonp');
    });
}
</script>

</body>

</html>

